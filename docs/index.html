<!DOCTYPE html>
<html class="style-dark">
  <head>
    <title>CompoundJS - build apps with love</title>
    <link rel="stylesheet" href="stylesheets/application.css">
    <link rel="stylesheet" href="stylesheets/prettify.css">
    <link href="http://fonts.googleapis.com/css?family=Quicksand:300" rel="stylesheet">
    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="javascripts/prettyprint.js"></script>
    <script src="javascripts/application.js"></script>
  </head>
  <body>
    <div class="sidebar">
      <div class="menu"></div>
      <ul class="items"></ul>
    </div>
    <div class="content-wrapper"><img src="images/logo.png" alt="CompoundJS" class="logo">
      <div class="style-switch"></div>
      <section id="routing">
        <h1>Routing</h1>
        <p>The purpose of routes is to connect a URL with a controller action. For example, you can define the following route in <code>config/routes.js</code> to link <code>GET /signup</code> with <code>new</code> action of <code>users</code> controller:</p>
        <pre class="prettyprint">map.get('signup', 'users#new');</pre>
        <p>The following route will link <code>GET /</code> to the <code>index</code> action of the<code>home</code> controller:</p>
        <pre class="prettyprint">map.root('home#index');</pre>
      </section>
      <section id="routing-resources">
        <h2>Resource-based routing</h2>
        <p>Resource-based routing provides standard mapping between HTTP verbs and controller actions:</p>
        <pre class="prettyprint">map.resources('posts');</pre>
        <p>will provide the following routes:</p>
        <pre class="prettyprint">&nbsp;&nbsp;helper | method | path                   | controller#action
    posts GET      /posts                   posts#index
    posts POST     /posts                   posts#create
&nbsp;new_post GET      /posts/new               posts#new
edit_post GET      /posts/:id/edit          posts#edit
     post DELETE   /posts/:id               posts#destroy
     post PUT      /posts/:id               posts#update
     post GET      /posts/:id               posts#show.
     </pre>
        <p>
           
          To list all available routes you can run the command <code>compound routes</code>.
        </p>
        <p>The first column of the table represents the <code>helper</code> - you can use this identifier in views and controllers to get the route. Some examples:</p>
        <pre class="prettyprint">path_to.new_post            # /posts/new
path_to.edit_post(1)        # /posts/1/edit
path_to.edit_post(post)     # /posts/1/edit (in this example post = {id: 1})
path_to.posts               # /posts
path_to.post(post)          # /posts/1.

</pre>
      </section>
      <section id="routing-resources-alias">
        <h2>Aliases for resourceful routes</h2>
        <p>If you want to override default routes behaviour, you can use two options: <code>as</code> and <code>path</code> to specify a helper name and a path you want to have in the result.</p>
        <section id="routing-resources-alias-as">
          <h3>{ as: 'helperName' }</h3>
          <p>Path helper aliasing:</p>
          <pre class="prettyprint">map.resources('posts', { as: 'articles' });</pre>
          <p>This will create the following routes:</p>
          <pre class="prettyprint">&nbsp;&nbsp;&nbsp;&nbsp;articles GET    /posts.:format?          posts#index
    articles POST   /posts.:format?          posts#create
&nbsp;new_article GET    /posts/new.:format?      posts#new
edit_article GET    /posts/:id/edit.:format? posts#edit
     article DELETE /posts/:id.:format?      posts#destroy
     article PUT    /posts/:id.:format?      posts#update
     article GET    /posts/:id.:format?      posts#show.
     </pre>
        </section>
        <section id="routing-resources-alias-path">
          <h3>{ path: 'alternatePath' }</h3>
          <p>If you want to change the base path:</p>
          <pre class="prettyprint">map.resources('posts', { path: 'articles' });</pre>
          <p>This will create the following routes:</p>
          <pre class="prettyprint">&nbsp;&nbsp;&nbsp;&nbsp;posts GET    /articles.:format?          posts#index
    posts POST   /articles.:format?          posts#create
&nbsp;new_post GET    /articles/new.:format?      posts#new
edit_post GET    /articles/:id/edit.:format? posts#edit
     post DELETE /articles/:id.:format?      posts#destroy
     post PUT    /articles/:id.:format?      posts#update
     post GET    /articles/:id.:format?      posts#show
     </pre>
        </section>
        <section id="routing-resources-alias-both">
          <h3>All together</h3>
          <p>If you want to alias both the helper and the path:</p>
          <pre class="prettyprint">map.resources('posts', { path: 'articles', as: 'stories' });</pre>
          <p>This will create the following routes:</p>
          <pre class="prettyprint">&nbsp;&nbsp;&nbsp;stories GET    /articles.:format?          posts#index
   stories POST   /articles.:format?          posts#create
&nbsp;new_story GET    /articles/new.:format?      posts#new
edit_story GET    /articles/:id/edit.:format? posts#edit
     story DELETE /articles/:id.:format?      posts#destroy
     story PUT    /articles/:id.:format?      posts#update
     story GET    /articles/:id.:format?      posts#show
     </pre>
        </section>
      </section>
      <section id="routing-nested-resources">
        <h2>Nested resources</h2>
        <p>Some resources may have nested sub-resources, for example <code>Post</code> has many <code>Comments</code>, and of course we want to get a post's comments using <code>GET /post/1/comments</code>.</p>
        <p>Let's describe the route for our nested resource:</p>
        <pre class="prettyprint">map.resources('post', function (post) {
  post.resources('comments');
});.
</pre>
        <p>This routing map will provide the following routes:</p>
        <pre class="prettyprint">$ compound routes
     post_comments GET      /posts/:post_id/comments          comments#index
     post_comments POST     /posts/:post_id/comments          comments#create
&nbsp;&nbsp;new_post_comment GET      /posts/:post_id/comments/new      comments#new
 edit_post_comment GET      /posts/:post_id/comments/:id/edit comments#edit
      post_comment DELETE   /posts/:post_id/comments/:id      comments#destroy
      post_comment PUT      /posts/:post_id/comments/:id      comments#update
      post_comment GET      /posts/:post_id/comments/:id      comments#show
             posts GET      /posts                            posts#index
             posts POST     /posts                            posts#create
      &nbsp;&nbsp;&nbsp;&nbsp;new_post GET      /posts/new                        posts#new
         edit_post GET      /posts/:id/edit                   posts#edit
              post DELETE   /posts/:id                        posts#destroy
              post PUT      /posts/:id                        posts#update
              post GET      /posts/:id                        posts#show.
              </pre>
        <section id="routing-url-helpers-nested">
          <h3>Using url helpers for nested routes</h3>
          <p>To use routes like <code>post_comments</code> you should call helper with param: parent resource or identifier before nested resource:</p>
          <pre class="prettyprint">path_to.post_comments(post)               # /posts/1/comments
path_to.edit_post_comment(post, comment)  # /posts/1/comments/10/edit
path_to.edit_post_comment(2, 300)         # /posts/2/comments/300/edit
</pre>
        </section>
      </section>
      <section id="routing-namespaces">
        <h2>Namespaces</h2>
        <p>You may wish to organize groups of controllers under a namespace. The most common use-case is an administration area. All controllers within the <code>admin</code> namespace should be located inside the <code>app/controllers/</code> directory.</p>
        <p>For example, let's create an admin namespace:</p>
        <pre class="prettyprint">map.namespace('admin', function (admin) {
  admin.resources('users');
});
</pre>
        <p>This routing rule will match with <code>/admin/users</code>, <code>/admin/users/new</code> and will create appropriate url helpers:</p>
        <pre class="prettyprint">&nbsp;&nbsp;&nbsp;&nbsp;admin_users GET    /admin/users.:format?          admin/users#index
    admin_users POST   /admin/users.:format?          admin/users#create
&nbsp;new_admin_user GET    /admin/users/new.:format?      admin/users#new
edit_admin_user GET    /admin/users/:id/edit.:format? admin/users#edit
     admin_user DELETE /admin/users/:id.:format?      admin/users#destroy
     admin_user PUT    /admin/users/:id.:format?      admin/users#update
     admin_user GET    /admin/users/:id.:format?      admin/users#show
     </pre>
      </section>
      <section id="restricting-routes">
        <h2>Restricting routes</h2>
        <p>
           
          If you need routes only for several actions (e.g. <code>index</code>, <code>show</code>), you can specify the <code>only</code> option:
        </p>
        <pre class="prettyprint">map.resources('users', { only: ['index', 'show'] });</pre>
        <p>
           
          If you want to have all routes except a specific route, you can specify the <code>except</code> option:
        </p>
        <pre class="prettyprint">map.resources('users', { except: ['create', 'destroy'] });</pre>
      </section>
      <section id="routing-custom-actions">
        <h2>Custom actions in resourceful routes</h2>
        <p>If you need some specific action to be added to your resource-based route, use this example:</p>
        <pre class="prettyprint">map.resource('users', function (user) {
  user.get('avatar', 'users#avatar');
});
</pre>
      </section>
      <section id="controllers">
        <h1>Controllers</h1>
        <p>
           
          In CompoundJS, a controller is a module that receives user input and initiates a response. Controllers consists of a set of actions. Each action is called by the request of a particular route. To define an action, you should use the reserved global function <code>action</code>.
        </p>
      </section>
      <section id="controllers-features">
        <h2>Features overview</h2>
        <p>Inside controller you can use following reserved global functions to control response:</p>
        <ul>
          <li><strong>render</strong> - render view template related to this action</li>
          <li><strong>send</strong> - send text, status code or json object to client</li>
          <li><strong>redirect</strong> - redirect client to specific location</li>
          <li><strong>header</strong> - send header to client</li>
          <li><strong>flash</strong> - display flash message</li>
        </ul>
        <p>And here is a bunch of functions to control execution flow:</p>
        <ul>
          <li><strong>before</strong> - invoke this method before any action</li>
          <li><strong>after</strong> - invoke this method after any action</li>
          <li><strong>load</strong> - load another controller to use its methods</li>
          <li><strong>use</strong> or <strong>export</strong> - get method defined in another controller, loaded using <code>load</code></li>
          <li><strong>publish</strong> or <strong>import</strong> - allow method to be used in other controller</li>
        </ul>
        <p>Let's learn more about each of this functions</p>
      </section>
      <section id="controllers-response-control">
        <h2>Response control</h2>
        <p><strong>NOTE: Each action should invoke exactly one output method. This is the only requirement imposed by the asynchronous nature of Node.js. If you don't call an output method, the client will infinitely wait for a server response.</strong></p>
      </section>
      <section id="controllers-render">
        <h3>render()</h3>
        <p>The <code>render</code> method accepts 0, 1 or 2 arguments. When called without any arguments, it just renders the view associated with this action. For example, this will render <code>app/views/posts/index.ejs</code>.</p><code>posts_controller.js</code>
        <pre class="prettyprint">action('index', function () {
  render();
});
</pre>
        <p>If you want to pass some data to the view, there are two ways to do it. First is to simply pass a hash containing the data:</p>
        <pre class="prettyprint">action('index', function () {
  render({ title: &quot;Posts index&quot; });
});
</pre>
        <p>
           
          and the second method is to set the properties of <code>this</code>:
        </p>
        <pre class="prettyprint">action('index', function () {
  this.title = &quot;Posts index&quot;;
  render();
});
</pre>
        <p>And if you want to render another view, just put its name as the first argument:</p>
        <pre class="prettyprint">action('update', function () {
  this.title = &quot;Update post&quot;;
  render('edit');
});
</pre>
        <p>or:</p>
        <pre class="prettyprint">action('update', function () {
  render('edit', { title: &quot;Update post&quot; });
});
</pre>
      </section>
      <section id="controllers-send">
        <h3>send()</h3>
        <p>The <code>send</code> function is useful for debugging and one-page apps where you don't want to render a heavy template and just want to send text or JSON data.</p>
        <p>This function can be called with number (status code):</p>
        <pre class="prettyprint">action('destroy', function () {
  send(403); // client will receive statusCode = 403 Forbidden
});
</pre>
        <p>or with a string:</p>
        <pre class="prettyprint">action('sayHello', function () {
  send('Hello!'); // client will receive 'Hello!'
});
</pre>
        <p>or with object:</p>
        <pre class="prettyprint">action('apiCall', function () {
  send({ hello: 'world' }); // client will receive '{&quot;hello&quot;:&quot;world&quot;}'
});
</pre>
      </section>
      <section id="controllers-redirect">
        <h3>redirect()</h3>
        <p>
           
          This function just sets the status code and <code>Location</code> header, so the client will be redirected to another location.
        </p>
        <pre class="prettyprint">redirect('/'); // root redirection
redirect('http://example.com'); // redirect to another host
</pre>
      </section>
      <section id="controller-flash">
        <h3>flash()</h3>
        <p>
           
          The <code>flash</code> function stores a message in the session for future displaying, this is a regular expressjs function, refer to <a href="http://expressjs.com/guide.html#req.flash()" target="_blank">expressjs guide</a> to learn how it works. Few examples:
        </p><code>posts_controller.js</code>
        <pre class="prettyprint">action('create', function () {
    Post.create(req.body, function (err) {
        if (err) {
            flash('error', 'Error while post creation');
            render('new', {post: req.body});
        } else {
            flash('info', 'Post has been successfully created');
            redirect(path_to.posts);
        }
    });
});
</pre>
        <p>
           
          This <code>create</code> action sends a flash info on success and a flash error on fail.
        </p>
      </section>
      <div id="controllers-execution-flow-control" class="section">
        <h2>Execution flow control</h2>
        <p>To provide the ability of DRY-ing controller code and reusing common code parts, CompoundJS provides a few additional tools: method chaining and external controllers loading.</p>
        <p>
           
          To chain methods, you can use the <code>before</code>  and<code>after</code> methods.
        </p><code>checkout_controller.js</code>
        <pre class="prettyprint">before(userRequired, { only: 'order' });
before(prepareBasket, { except: 'order' });
before(loadProducts, { only: ['products', 'featuredProducts'] });

action('products', function () { ... });
action('featuredProducts', function () { ... });
action('order', function () { ... });
action('basket', function () { ... });

function userRequired () { next() }
function prepareBasket () { next() }
function loadProducts () { next() }
</pre>
        <p>In this example, <code>userRequired</code> will be called only for the<code>order</code> action, <code>prepareBasket</code> will be called for all actions except <code>order</code>, and <code>loadProducts</code> will be called only for the <code>products</code> and <code>featuredProducts</code>methods.</p>
        <p>
           
          Note, that the before-functions should call the global <code>next</code> method that will pass control to the next function in the chain.
        </p>
      </div>
      <div id="controllers-common-execution-context" class="section">
        <h2>Common execution context</h2>
        <p>There is one extra feature in flow control: All functions are invoked in the same context, so you can pass data between the functions using the <code>this</code> object:</p>
        <pre class="prettyprint">function loadProducts () {
    Product.find(function (err, prds) {
        this.products = prds;
        next();
    }.bind(this));
}

action('products', function () {
    assert.ok(this.products, 'Products available here');
    render(); // also products will available in view
});
</pre>
      </div>
      <div id="controllers-sharing-code" class="section">
        <h2>Sharing code across controllers</h2>
        <p> Some methods, like <code>userRequired</code> for example, can be used in different controllers. To allow cross-controller code sharing, CompoundJS provides a few methods: <code>load</code>, <code>use</code> and <code>publish</code>.</p>
        <p>You can define <code>requireUser</code> in <code>application_controller.js</code> and call <code>publish</code> to make it accessible to all other controllers that inherit from this controller:</p><code>application_controller.js</code>
        <pre class="prettyprint">publish('requireUser', requireUser);

function requireUser () {
  // ...
}
</pre><code>products_controller.js</code>
        <pre class="prettyprint">load('application'); // note that _controller siffix omitted
before(use('userRequired'), { only: 'products' });
</pre>
      </div>
      <div id="controllers-other-expressjs" class="section">
        <h2>Other express.js features</h2>
        <p>
           
          To get familiar with CompoundJS controllers, look at a few examples available at github: <a href="https://github.com/anatoliychakkaev/railwayjs.com/blob/master/app/controllers/pages_controller.coffee" target="_blank">coffee controller</a>, <a href="https://github.com/1602/router/blob/master/app/controllers/users_controller.js" target="_blank">javascript controller</a>.
        </p>
        <p>
           
          All other expressjs features have no global shortcuts yet, but they can still be used since <code>request</code> (alias  <code>req</code>) and <code>response</code> (alias <code>res</code>) are available as global variables inside the controller context. In the view context, they are available as <code>request</code> and <code>response</code>.
        </p>
      </div>
    </div>
  </body>
</html>